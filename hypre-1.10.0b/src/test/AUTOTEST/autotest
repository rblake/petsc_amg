#!/bin/sh
#BHEADER***********************************************************************
# (c) 1998   The Regents of the University of California
#
# See the file COPYRIGHT_and_DISCLAIMER for a complete copyright
# notice, contact person, and disclaimer.
#
# $Revision: 1.107 $
#EHEADER***********************************************************************

perform_test()
{
  echo ""
  echo "======================================================================"
  echo "Running tests $HYPRE_MACHINE_COMMANDS in directory $HYPRE_REMOTE_DIR"
  echo "======================================================================"
  echo ""

#=============================================================================
#   Running tests on same machine as that executing this script
#   Destroy old directory; copy newly checked out version; cd to
#   HYPRE_REMOTE_DIR, create a temporary file indicating tests have started,
#   execute tests and create another temporary file to indicate tests completed.
#=============================================================================
  if [ "${HYPRE_COMPILE_MACHINE}" = "`hostname | sed 's/\..*$//'`" ]
  then
     if [ "${HYPRE_REMOTE_DIR}" != "${HYPRE_AUTOTEST_EXECUTE_DIR}" ]
     then
        rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers
        cp -fpr ${HYPRE_AUTOTEST_EXECUTE_DIR}/linear_solvers ${HYPRE_REMOTE_DIR}
     fi
     cd ${HYPRE_REMOTE_DIR}
     echo "Autotest Started" > "autotest_start"
     [ -f linear_solvers/test/AUTOTEST/env.${HYPRE_ARCH} ] && \
        . linear_solvers/test/AUTOTEST/env.${HYPRE_ARCH} ${COMPILERSELECT}
     rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers/autotest.*
     rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers/test/autotest.*
     linear_solvers/test/AUTOTEST/autotest_test \
         ${HYPRE_MACHINE_COMMANDS} -v ${HYPRE_MESSAGE}
     echo "Autotest Done" > "autotest_done"

#=============================================================================
#   Running tests on remote machine
#     ssh to compile machine and remove existing linear_solvers directory
#     copy source code from the current directory to defined remote directory
#     ssh to remote machine, create a temporary file indicating tests have 
#     started, execute tests and create another temporary file to indicate tests
#     completed.
#=============================================================================
  else
    echo "deleting old AUTOTEST directory...."
    ssh ${HYPRE_COMPILE_MACHINE} "\
    (/bin/sh -c \"\
        rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers;\"\
    )"

    echo "copying new source...."
    cp -fpr linear_solvers ${HYPRE_REMOTE_DIR}

    echo "Begin running remote tests...."
    ssh -f ${HYPRE_COMPILE_MACHINE} "\
    (/bin/sh -c \"\
      cd ${HYPRE_REMOTE_DIR##*:};\
      echo "Autotest Started" > "autotest_start";\
      [ -f linear_solvers/test/AUTOTEST/env.${HYPRE_ARCH} ] && \
        . linear_solvers/test/AUTOTEST/env.${HYPRE_ARCH} ${COMPILERSELECT};\
      rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers/autotest.*;\
      rm -fR ${HYPRE_REMOTE_DIR}/linear_solvers/test/autotest.*;\
      linear_solvers/test/AUTOTEST/autotest_test \
            ${HYPRE_MACHINE_COMMANDS} -v ${HYPRE_MESSAGE};\
      echo "Autotest Done" > "autotest_done";\
      chmod -fR a+rX,ug+w,o-w linear_solvers;\
      chgrp -fR hypre linear_solvers\"\
    )" 
  fi
  echo "returning to autotest...."
}


#=============================================================================
# Function for display of help/usage
#=============================================================================
help () {
  printf "Usage: $0 [-nocvs|-rev Rev#] [-h|-help] [-d|-debug] HostOptions [HostOptions ... ]\n"
  printf "\n"
  printf "HYPRE autotest script. This is the high level wrapper for the\n"
  printf "autotest_test script, which is run nightly from cron. This script\n"
  printf "determines which systems autotest_test is to be executed on, and the\n"
  printf "options to use.\n"
  printf "\n"
  printf "%s\n" "-nocvs    Do not checkout the latest source code from CVS.\n"
  printf "                 Use the existing ./linear_solvers/ directory for\n"
  printf "                 testing.\n"
  printf "%s\n" "-rev Rev# Check out the specified revision or tagged source\n" 
  printf "%s\n" "          from CVS.\n" 
  printf "%s\n" "-help     Print this information and exit.\n" 
  printf "%s\n" "-debug    Turn on debug mode.\n" 
  printf "\n"
  printf "HostOptions      Host ID or configuration on which autotest_test is to be run.\n"
  printf "                 Valid host IDs are:\n"
  printf "%s\n" "     -gps       Compaq gps320 system."
  printf "%s\n" "     -gpsmp     Compaq gps320 system executing OpenMP."
  printf "%s\n" "     -ilx       Intel running Linux."
  printf "%s\n" "     -insure    CASC Linux, executing insure++."
  printf "%s\n" "     -mcr       Intel Linux, CHAOS."
  printf "%s\n" "     -pengra    Intel Linux, CHAOS."
  printf "%s\n" "     -red       ASCI Red"
  printf "%s\n" "     -tux149    CASC running RedHat Enterprise Linux."
  printf "%s\n" "     -tuxgcc    CASC running latest gcc compilers"
  printf "%s\n" "     -tuxpgi    CASC running latest PGI compilers"
  printf "%s\n" "     -tuxabsoft CASC running Absoft-Pro8.0 Fortran 90"
  printf "%s\n" "     -tuxlahey  CASC running Lahey Fortran compiler"
  printf "%s\n" "     -tuxintel  CASC running latest Intel compilers"
  printf "%s\n" "     -tuxkai    CASC running latest KAI KCC compiler"
  printf "\n"
}


usage ()
{
  printf "Usage: $0 [-nocvs|-rev Rev#] [-h|-help] [-d|-debug] HostOptions [HostOptions ... ]\n"
}


#==============================================================================
#    Sets options for machines on which regression tests are being run
#==============================================================================
hypre_set_machine_options()
{
  case $1 in
     -gps)
        HYPRE_ARCH="dec"
        HYPRE_COMPILE_MACHINE="gps"
        HYPRE_RUN_MACHINE="gps320"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/tru64_5/AUTOTEST"
	HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -nse 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[GPS]'
        ;;
     -gpsmp)
        HYPRE_ARCH="dec"
        HYPRE_COMPILE_MACHINE="gps"
        HYPRE_RUN_MACHINE="gps320"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/tru64_5/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -nse 1 -a 1 -cfo 2"
        HYPRE_MESSAGE='SECONDARY[OpenMP-GPS]'
        ;;
     -ilx)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="ilx"
        HYPRE_RUN_MACHINE="ilx"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/chaos_3_x86/AUTOTEST"
	HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -ne 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[ILX]'
        ;;
     -insure)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-insure/AUTOTEST"
	HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -i 2"
        HYPRE_MESSAGE='PRIMARY[insure++]'
        ;;
     -mcr)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="mcr"
        HYPRE_RUN_MACHINE="mcr"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/chaos_3_x86_elan3/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -nse 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[MCR]'
        ;;
     -pengra)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="pengra"
        HYPRE_RUN_MACHINE="pengra"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/chaos_3_x86_elan3/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -nse 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[Pengra]'
        ;;
     -red)
        HYPRE_ARCH="red"
        HYPRE_COMPILE_MACHINE="sasn100"
        HYPRE_RUN_MACHINE="janus"
        HYPRE_REMOTE_DIR="/usr/apps/hypre/AUTOTEST"
	HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -o 1 -a 2 -cf"
        HYPRE_MESSAGE='OTHER[RED]'
        ;;
     -tux149)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -b 1 -nsde 1 -a 2 -cf"
        HYPRE_MESSAGE='PRIMARY[default]'
        COMPILERSELECT="default"
        ;;
     -tuxpgi)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-pgi5.x/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -ndse 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[pgi]'
        COMPILERSELECT="pgi"
        ;;
     -tuxabsoft)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-gcc3.x/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -b 1 -nde 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[Absoft-Pro8.0]'
        COMPILERSELECT="absoft"
        ;;
     -tuxlahey)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-gcc3.x/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -b 1 -nde 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[lahey]'
        COMPILERSELECT="lahey"
        ;;
     -tuxintel)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-gcc3.x/AUTOTEST"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -b 1 -nde 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[Intel-8.0]'
        COMPILERSELECT="intel"
        ;;
     -tuxkai)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="/usr/casc/hypre/i686-pc-linux-gnu-kai/AUTOTEST"
	HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -b 1 -nde 1 -a 2 -cf"
        HYPRE_MESSAGE='SECONDARY[KCC]'
        COMPILERSELECT="kai"
        ;;
     -tuxlocal)
        HYPRE_ARCH="linux"
        HYPRE_COMPILE_MACHINE="tux149"
        HYPRE_RUN_MACHINE="tux149"
        HYPRE_REMOTE_DIR="`pwd`"
        HYPRE_MACHINE_COMMANDS="-r $HYPRE_RUN_MACHINE -e 2"
        HYPRE_MESSAGE='LOCAL-TEST[default]'
        COMPILERSELECT="default"
        ;;
  esac
}

#==============================================================================
# Beginning of 'main program' of script for regression testing hypre.
# Initialize variables
#==============================================================================
DEBUG_MODE=""
HYPRE_MESSAGE=""
COMPILERSELECT=""
HYPRE_RUN_MACHINE=""
HYPRE_AUTOTEST_EXECUTE_DIR="`pwd`"
export HYPRE_RUN_MACHINE
export HYPRE_MESSAGE COMPILERSELECT HYPRE_AUTOTEST_EXECUTE_DIR

CVSROOT=/home/casc/repository
export CVSROOT


#=============================================================================
# Parse command line arguments.  If no args, print usage info and exit.
# the nocvs/rev/help/debug arguments are expected to precede all HostOptions
#=============================================================================
if [ $# -lt 1 ]
then
  usage
  exit 2
fi
case $1 in
    -h|-help) 
        help
        exit
        ;;
    -d|-debug) 
        DEBUG_MODE="yes"
        set -xv
        shift
        ;;
esac


#=============================================================================
# Define permissions
#=============================================================================
OldMask=`umask -S`
umask u=rwx,g=rx,o=rx


#=============================================================================
# Check out the repository into the HYPRE_REMOTE_DIR directory, if requested.
# The repository resides on the CASC cluster; before checking out a new version
# existing versions are removed.
#=============================================================================
if [ "$1" = "-nocvs" ]
then
   shift
else
   if [ ! -d "$CVSROOT" ]
   then
      echo "Error: no CVS repository location found, CVSROOT = $CVSROOT"
      exit
   fi
   rm -fR linear_solvers
   if [ "$1" = "-rev" ]
   then
      REV=$2
      shift
      shift
      cvs -q checkout -r $REV -P linear_solvers 1> $0.checkout.log 2> $0.checkout.err
   else
      cvs -q checkout -P linear_solvers 1> $0.checkout.log 2> $0.checkout.err
   fi
   chmod -f a+rX,ug+w,o-w $0.checkout.*
   chgrp -f hypre $0.checkout.*
fi


#==============================================================================
# set permissions and group for linear_solvers directory
#==============================================================================
chmod -fR a+rX,ug+w,o-w linear_solvers
chgrp -fR hypre linear_solvers


#==============================================================================
# Run test suites on remote machines
# NOTE: the command line should ONLY have the HostOptions left for parsing
#       allowances are made in this loop for other options to be interspersed
#==============================================================================

while [ "$*" != "" ]
do
  HYPRE_RUN_MACHINE=""
  COMPILERSELECT=""
  arg=$1
  cd ${HYPRE_AUTOTEST_EXECUTE_DIR}
  case ${arg} in
    -d|-debug) 
        DEBUG_MODE="yes"
        set -xv
        shift;;
    -h|-help) 
        help
        exit;;
    -nocvs)
        echo "ERROR: -nocvs option MUST be first argument! Quiting..."
        help
        exit;;
    *)
        hypre_set_machine_options ${arg}
        perform_test
        shift;;
  esac

done


#==============================================================================
#    Reset permissions
#==============================================================================
chmod -fR a+rX,ug+w,o-w ${HYPRE_REMOTE_DIR}/linear_solvers
chgrp -fR hypre ${HYPRE_REMOTE_DIR}/linear_solvers


#==============================================================================
# Restore original permissions
#==============================================================================
umask $OldMask
